<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="https://rsms.me/inter/inter.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/selekkt-skelet@latest/css/skelet.min.css">
		<!-- having trouble getting the right path on both umbrel and local.. -->
		<link rel="stylesheet" href="style.css">
		<link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16x16.png">
		<link rel="manifest" href="favicons/site.webmanifest">
		<link rel="mask-icon" href="favicons/safari-pinned-tab.svg" color="#5bbad5">
		<link rel="shortcut icon" href="favicon.ico">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="msapplication-config" content="favicons/browserconfig.xml">
		<meta name="theme-color" content="#ffffff">
		<title>nolooking // Lightning PayJoin</title>
	</head>
	<body dark-mode>
		<br>
		<br>
		<header class="center">
			<a href="https://nolooking.chaincase.app/" target="_blank" style="text-decoration:none"><h1>ðŸ‘» &nbsp;Lightning PayJoin&nbsp; ðŸ‘»</h1></a>
			<h3 style="color: orange;">ðŸŽƒ Halloween Alpha [experimental] | Avoid spðŸ‘€ks</h3>
			<h2>Queue batches of lightning channels to open in a single transaction</h2>
		</header>
		<main class="center-axyz">
			<form action="/schedule" method="post" enctype="application/x-www-form-urlencoded"
				x-flex direction="column">
				<fieldset>
					<legend>Config</legend>
					<div>
						<label for="reserve">
							<details>
								<summary>
									Anchor Reserve Deposit (sats)
								</summary>
								New nodes need a reserve output of at least 10,000 sats. Set this to 10,000 fo a new node. 0 is fine thereafter.
							</details>
						</label>
						<input type="number" name="wallet_amount" id="wallet" list="defaultReserveSats" min="0" step="1" value="0">
						<datalist id="defaultReserveSats">
							<option value="10000"></option>
						</datalist>
					</div>
					<div>
						<label for="fee_rate">Maximum fee rate (sats/vB)</label>
						<input type="number" name="fee_rate" id="feerate" value="1" min="1"><!-- /schedule api accepts u64 -->
					</div>
				</fieldset>
				<fieldset style="min-width: 706px; width: 100%;">
					<legend>Queue Channels to Open</legend>
					<!-- channels -->
					<x-grid columns=2 id="channels">
						<label id="destinationLabel" span=1>Destination Node</label><label id="capacityLabel" span=1>Channel Capacity (sats)</label>
						<input type="text" name="channels[0][node]" aria-labelledby="destinationLabel" placeholder="node@host:port" required>
						<!-- LND enforces minimum 20k sats channel -->
						<input type="number" id="input_sats" name="channels[0][amount]" min="20000" step="1" aria-labelledby="capacityLabel" required>
					</x-grid>
					<p>
						<x-flex>
							<button type="button" class="is-circle" onclick="add_channel()">+</button>
							<button type="button" class="is-circle" onclick="remove_channel()">-</button>
						</x-flex>
					</p>
					<div>
				</fieldset>
				<fieldset class="recommendation-wrapper">
					<legend>Get Recommended Outbound Channels</legend>
					<div class="recommendation-button-wrapper">
						<button type="button" onclick="get_recommended_channels()">Get Recommended Channels</button>
					</div>
					<div class="recommendation-node-wrapper invisible">
						<h2 class="routing-node-title">Routing Node</h2>
						<ul class="recommendation-node-list">
							<li class="recommendation-node-property"><span class="routing-node-alias"></span></li>
							<li class="recommendation-node-property">&nbsp;Active Capacity:&nbsp;<span class="routing-node-capacity"></span> | &nbsp;Channel Count:&nbsp;<span class="routing-node-count"></span></li> 
							<li class="recommendation-node-property"><span class="routing-node-address"></span></li>
						</ul>
						<div class="recommendation-node-button-wrapper">
							<button type="button" onclick="add_recommended_node('routing_node')">Use</button>
						</div>
					</div>
					<div class="recommendation-node-wrapper invisible">
						<h2 class="routing-node-title">Edge Node</h2>
						<ul class="recommendation-node-list">
							<li class="recommendation-node-property"><span class="edge-node-alias"></span></li>
							<li class="recommendation-node-property">&nbsp;Active Capacity:&nbsp;<span class="edge-node-capacity"></span> | &nbsp;Channel Count:&nbsp;<span class="edge-node-count"></span></li> 
							<li class="recommendation-node-property"><span class="edge-node-address"></span></li>
						</ul>
						<div class="recommendation-node-button-wrapper">
							<button type="button" onclick="add_recommended_node('edge_node')">Use</button>
						</div>
					</div>
					<div class="recommendation-node-wrapper invisible">
						<h2 class="wildcard-node-title">Wildcard Node</h2>
						<ul class="recommendation-node-list">
							<li class="recommendation-node-property"><span class="wildcard-node-alias"></span></li>
							<li class="recommendation-node-property">&nbsp;Active Capacity:&nbsp;<span class="wildcard-node-capacity"></span> | &nbsp;Channel Count:&nbsp;<span class="wildcard-node-count"></span></li> 
							<li class="recommendation-node-property"><span class="wildcard-node-address"></span></li>
						</ul>
						<div class="recommendation-node-button-wrapper">
							<button type="button" onclick="add_recommended_node('nolooking_node')">Use</button>
						</div>
					</div>
				</fieldset>
				<br>
				<div id="queue">
					<x-grid columns=2>
						<button type="submit" class="float-right" span="2">Generate Funding Request</button>
					</x-grid>
				</div>
				<output id="queued" class="invisible">
					<h2>PayJoin here to open these channels</h2>
					<p class="warning">âš  This software is still extremely experimental and has not been vetted, use at your own risk âš </code>
					<div id="qrcode" class="center-axyz"></div>
					<a href="" id="bip21"></a>
					<p>Please use <a href="https://en.bitcoin.it/wiki/PayJoin_adoption" target="_blank">a wallet that supports</a> BIP 78 <a href="https://bitcoinmagazine.com/culture/blockchain-analysis-about-get-harder-p2ep-enters-testing-phase" target="blank">P2EP</a> PayJoins!</p>
				</output>
			</form>

		</main>
		<script type="text/javascript">
			let recommendations;
			function add_channel(address=""){
				var channels = document.getElementById("channels");
				let div = document.createElement('div');
				if (address == "") {
					div.innerHTML = `<input type="text" name="channels[${channels.length + 1}][node]" aria-labelledby="destinationLabel" placeholder="node@host:port" span="1" required><input type="number" name="channels[${channels.length + 1}][amount]" min="20000" step="1" aria-labelledby="capacityLabel" span="1" required>`;
				} else {
					div.innerHTML = `<input type="text" value="${address}" name="channels[${channels.length + 1}][node]" aria-labelledby="destinationLabel" placeholder="node@host:port" span="1" required><input type="number" name="channels[${channels.length + 1}][amount]" min="20000" step="1" aria-labelledby="capacityLabel" span="1" required>`;
				}
				channels.appendChild(div.firstChild);
				channels.appendChild(div.lastChild);
			}

			function remove_channel() {
				let channels = document.getElementById("channels");
				let channelInputs = channels.getElementsByTagName("input");
				if (channelInputs.length <= 2 ) {
					// length <= [node id, channel capacity]
					return;
				}
				channels.removeChild(channels.children[channels.children.length - 1]);
				channels.removeChild(channels.children[channels.children.length - 2]);
			}

			async function get_recommended_channels(){
				document.getElementsByClassName('recommendation-button-wrapper')[0].innerHTML.text = "Refresh Recommended Channels"
				try {
					recommendations = await (await fetch('/recommended', {
						method: 'GET',
					})).json()
					document.getElementsByClassName('routing-node-alias')[0].innerHTML = recommendations.routing_node.alias
					document.getElementsByClassName('routing-node-capacity')[0].innerHTML = recommendations.routing_node.capacity
					document.getElementsByClassName('routing-node-count')[0].innerHTML = recommendations.routing_node.active_channel_count
					document.getElementsByClassName('wildcard-node-alias')[0].innerHTML = recommendations.nolooking_node.alias
					document.getElementsByClassName('wildcard-node-capacity')[0].innerHTML = recommendations.nolooking_node.capacity
					document.getElementsByClassName('wildcard-node-count')[0].innerHTML = recommendations.nolooking_node.active_channel_count
					document.getElementsByClassName('edge-node-alias')[0].innerHTML = recommendations.edge_node.alias
					document.getElementsByClassName('edge-node-capacity')[0].innerHTML = recommendations.edge_node.capacity
					document.getElementsByClassName('edge-node-count')[0].innerHTML = recommendations.edge_node.active_channel_count
					Array.from(document.getElementsByClassName('recommendation-node-wrapper')).forEach(el => el.classList.remove('invisible'));
				} catch (error) {
					console.error(error)
					alert("Something went wrong. Please try again.")
				}
			}

			function add_recommended_node(type = 'routing_node') {
				const node = recommendations[type];
				if (!node) {
					alert("Something went wrong. Please try again.");
					return;
				}
				const pubkey = node.public_key;
				const socket = node.sockets.includes(',') ? node.sockets.split(',')[0] : node.sockets;
				add_channel(`${pubkey}@${socket}`);

			}

			document.querySelector("form").addEventListener("submit", async (event) => {
				event.preventDefault();
				let form = event.currentTarget;
				let resource = form.action;
				let options = {
					method: form.method,
					headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
					// encode FormData as x-www-form-urlencoded
					body: new URLSearchParams(new FormData(form)).toString()
				};

				await fetch(resource, options)
					.then(async (r) => {
						console.debug(r);
						if (!r.ok)
							throw new Error('Something went wrong.');

						let link = document.getElementById("bip21");
						let bip21 = await r.text();
						link.href = bip21;
						link.innerHTML = bip21;

						var address = bip21.split("bitcoin:")[1].split("?")[0];
						document.getElementById("qrcode").innerHTML = `<img src="/qr_codes/${address}.png" width="256px" />`;
						document.getElementById("queue").classList.add("invisible");
						document.getElementById("queued").classList.remove("invisible");
					})
					.catch((err) => {
						alert(err);
					});
				return false; // don't trigger form action attribute, we submitted through js
			});
		</script>
	</body>
</html>
